var images={localId:[],serverId:[],allcount:3,leftcount:0,curcount:0,count:0,hasImg:false,imgflag:0};function checkImg(){var imglst=$(".img");if(imglst.length>0){return true}else{return false}}function butSubmit(){var XSAccount=$("#XSAccount").val(),XSPassword=$("#XSPassword").val();if(XSAccount==""||XSAccount.indexOf("请输入")>-1||XSPassword==""||XSPassword.indexOf("请输入")>-1){errShow({"errmsg":"请输入帐号密码","errcode":""});return}else if(!checkImg()||images.imgflag==0){errShow({"errmsg":"请先上传图片","errcode":""});return}window.location.href="/InterFace/ValidateCenter/StudentPaper.ashx?type=submit&Account="+XSAccount+"&Password="+XSPassword}function showImg(){$.ajax({url:"/InterFace/ValidateCenter/StudentPaper.ashx",type:"post",dataType:"json",cache:false,data:{"type":"loadimg"},success:function(msg){var imglist=msg.XS;$("#XSAccount").val(msg.XSAccount);$("#XSPassword").val(msg.XSPassword);for(var i=0;i<imglist.length;i++){$(".uppic").before("<li class='upflpic'><img  id='img_"+imglist[i].type_detail+"' src='"+imglist[i].Img+"' class='img' style='width:100%; height:100%;'><i onclick=deleteImg(this)'></i></li>")}if(imglist.length>0){images.imgflag=1}else{images.imgflag=0}}})}wx.ready(function(){$("#inputa").on("click",function(){var has=$(".img:last").attr("id");if(has){images.hasImg=true;images.curcount=has.split('_')[1];images.count=$(".img").length;images.leftcount=images.allcount-images.count;if(images.leftcount<=0){errShow({"errmsg":"最多上传3张图片","errcode":""});return}}else{images.leftcount=images.allcount}images.localId=[];wx.chooseImage({count:images.leftcount,sizeType:['compressed'],sourceType:['album','camera'],success:function(res){for(var i=0;i<res.localIds.length;i++){images.localId[i]=res.localIds[i];var imgname='img_';if(images.hasImg){images.curcount++;imgname+=images.curcount}else{imgname+='1';images.curcount=1;images.hasImg=true}$(".uppic").before("<li class='upflpic'><img  id='"+imgname+"' src='"+images.localId[i]+"' class='img' style='width:100%; height:100%;'><i onclick='deleteImg(this)'></i></li>")}uploadImg()}})});function uploadImg(){var i=0;images.serverId=[];var uploadAPI=function(){setTimeout(function(){wx.uploadImage({localId:images.localId[i].toString(),isShowProgressTips:1,success:function(res){images.serverId.push(res.serverId);++i;if(i<images.localId.length){uploadAPI()}else{ajaxImg()}},fail:function(res){errShow({"errmsg":"上传失败,请刷新重试.","errcode":""});return}})},100)};uploadAPI()}function ajaxImg(){$.ajax({url:"/InterFace/ValidateCenter/StudentPaper.ashx",type:"post",dataType:"json",cache:false,data:{"type":"upload","type_detail":"","serverId":images.serverId.join(",")},success:function(msg){if(msg.errmsg!="success"){errShow({"errmsg":"上传失败,请刷新重试.","errcode":""});images.imgflag=0;return}else{images.imgflag=1}}})}});function deleteImg(obj){var id=$(obj).parent().find("img").attr("id");var detail=id.split("_")[1];$(obj).parent().remove();$.ajax({url:"/InterFace/ValidateCenter/StudentPaper.ashx",type:"post",dataType:"json",cache:false,data:{"type":"delete","type_detail":detail},success:function(msg){if(msg.errmsg!="success"){errShow({"errmsg":"删除图片失败,请刷新重试.","errcode":""});return}}})}function errShow(obj){if(obj.errmsg||obj.errcode){$("#remind02 .motwo_wz").html(obj.errmsg);$("#remind02 .motwo_wz404").html("错误码:"+obj.errcode);$("#remind02").css("display","block");return false}return true}