<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<title>工作-通话详单</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">
<meta http-equiv="cleartype" content="on">
<link href="../../css/NEW/style.css" rel="stylesheet" type="text/css">
</head>

<body class="f5">
<div class="content contpad">
    <div class="credit"> 
        <!--<div class="credit_tab">
                <ul>
                    <li class="active">服务密码获取</li>
                    <li>直接截图</li>
                </ul>
            </div>-->
        <div class="qhtab">
            <div class="add_bank wid_13">
                <ul>
                    <div class="tel_rztab"> 
                        
                        <!--<li class="yzfs">
                                <b>电商数据</b>
                                <div class="fl yzfs_rt">
                                    <input id="yzfs01" name="yzfsname" type="radio" checked="checked"><label id="label01" class="pass" for="yzfs01">淘宝帐号</label>
                                    <input id="yzfs02" name="yzfsname" type="radio" checked=""><label id="label02" for="yzfs02">京东帐号</label>
                                </div>
                            </li>-->
                        <li id="fwpw" class="pr"><b>服务密码</b>
                            <input type="text" id="phone" placeholder="请输入服务密码">
                            <input id="btnemail" class="send-mess gcolor" name="" type="button" onclick="msg_req('')" value="验 证">
                        </li>
                        <li id="newpw" style="display: none;"><b>新密码</b>
                            <input id="newfwpw" name="" type="text" placeholder="请输入新密码" value="">
                        </li>
                        <li id="newyzm" class="pr" style="display: none;"><b>验证码</b>
                            <input id="newfwyzm" name="" type="text" placeholder="请输入验证码" value="">
                            <input id="newyzm_reset" onclick="reset_sendyzm()" class="send-mess gcolor btn_yzm" name="" type="button" value="重新获取">
                        </li>
                    </div>
                </ul>
            </div>
            <div class="both bank_bom" style="display: none;">
                <p>
                    <input id="resetpw" name="" class="hs" type="button" onclick="reset_pw('SUBMIT_RESET_PWD')" value="忘记密码">
                </p>
                <p>
                    <input id="retrunlog" onclick="relogin()" name="" class="xt" type="button" value="返回登录">
                </p>
            </div>
            <div class="file_linr fff">
                <div class="tel_table">
                    <p>忘记密码可通过以下方式找回：</p>
                    <table border="0" cellspacing="1" cellpadding="0">
                        <tr class="tt">
                            <td class="tdwid01"></td>
                            <td class="tdwid02">1、手机拨号-转人工服务</td>
                            <td class="tdwid03">2、手机登陆网址-“忘记密码”查询</td>
                        </tr>
                        <tr>
                            <td><p class="pic_yd"></p></td>
                            <td><a href="tel://10086">10086</a></td>
                            <td>10086.cn</td>
                        </tr>
                        <tr>
                            <td><p class="pic_lt"></p></td>
                            <td><a href="tel://10010">10010</a></td>
                            <td>wap.10010.com</td>
                        </tr>
                        <tr>
                            <td><p class="pic_dx"></p></td>
                            <td><a href="tel://10000">10000</a></td>
                            <td>wapzt.189.cn</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <form id="user" name="user" method="post" enctype="multipart/form-data" action="">
            <div class="online_bom pabom qhtab" style="display:none">
                <p class="tt">通话截图</p>
                <div class="bankfile">
                    <ul>
                        <li class="upflpic"><img src="../../images/NEW/404.png"><i></i></li>
                        <li class="upflpic"><img src="../../images/NEW/404.png"><i></i></li>
                        <li class="upflpic"><img src="../../images/NEW/404.png"><i></i></li>
                        <li class="upflpic"><img src="../../images/NEW/404.png"><i></i></li>
                        <li class="upflpic"><img src="../../images/NEW/404.png"><i></i></li>
                        <li class="upflpic"><img src="../../images/NEW/404.png"><i></i></li>
                        <li class="uppic">
                            <input name="" type="file" accept="image/*">
                            <img src="../../images/NEW/rz_06.png"> </li>
                    </ul>
                </div>
                <p class="ztips">注：上传截图中必须有一张可以看清实名信息，及6个月通话详单!</p>
                <p class="tt">图片实例图</p>
                <div class="house_bom">
                    <div class="fl"><img src="../../images/NEW/auth20.jpg"><br>
                        个人信息</div>
                    <div class="fr"><img src="../../images/NEW/auth21.jpg"><br>
                        通话详单</div>
                </div>
                <p class="ztips dheie">注：暂时支持图片格式：jpg/png/xls/xlsx</p>
            </div>
            <div class="both bank_bom">
                <p class="tips"><img src="../../images/NEW/input_01.png"><span>如有疑问，联系客服:<a onclick="document.getElementById('guided_mod').style.display='block'">请点击</a></span></p>
                <p class="tips" style="margin-left:0.67rem;">注:为了您的安全，我们不会保存任何密码记录</p>
                <p>
                    <input name="" class="" type="button" value="确定">
                </p>
            </div>
        </form>
    </div>
</div>

<!--手机认证提示01-->
<div id="remind01" class="modal01" style="display:none;">
    <div class="modal_bg"></div>
    <div class="modal02_nr">
        <p class="modtwo_tp"><img src="../../images/NEW/modal01.png"><span>请输入短信验证码</span></p>
        <p class="motwo_wz">
            <input id="reqyzm" name="" onfocus="reqyzmfocus()" type="text" class="sz" placeholder="888888" value="">
        </p>
        <p id="yzmerr" style="margin:auto; text-align:center;color:red;display:none;">短信验证码格式错误，请重新输入</p>
        <p class="motwo_annv" onclick="msg_req('SUBMIT_CAPTCHA')">确定</p>
    </div>
</div>
<!--手机认证提01示--> 
<!--手机认证提示02-->
<div id="remind02" class="modal01" style="display:none;">
    <div class="modal_bg"></div>
    <div class="modal02_nr">
        <p class="modtwo_tp"><img src="../../images/NEW/modal01.png"><span>分期X温馨提示</span></p>
        <p class="motwo_wz"></p>
        <!--<i class="yes"></i>恭喜你！验证成功-->
        <p class="motwo_annv" onclick="javascript: $('#remind02').css({ 'display': 'none' });">确定</p>
    </div>
</div>

<!--手机认证提02示--> 
<!--手机认证提示03-->
<div id="remind03" class="modal01" style="display:none;">
    <div class="modal_bg"></div>
    <div class="modal02_nr">
        <p class="modtwo_tp"><img src="../../images/NEW/modal01.png"><span>分期X温馨提示</span></p>
        <div class="yzloser">
            <p class="bhyslo"></p>
        </div>
        <p class="motwo_annv" onclick="javascript: $('#remind03').css({ 'display': 'none' });"></p>
    </div>
</div>
<!--手机认证提03示--> 

<!--加载中-->
<div id="loading" class="modal01" style="display:none;">
    <div class="modal_bg"></div>
    <div class="modal02_nr">
        <p class="modtwo_tp"><img src="../../images/NEW/modal01.png"><span>分期X温馨提示</span></p>
        <p class="modloading"><img src="../../images/NEW/loading.gif"><br>
            正在加载中...</p>
    </div>
</div>

<!--选择电商-->
<div class="modal01" id="bussele" style="display:none;">
    <div class="modal_bg"></div>
    <div class="modal02_nr">
        <p class="modtwo_tp"><img src="../../images/NEW/modal01.png"><span>电商验证选择</span></p>
        <div class="onlitab">
            <div class="onli_yzfs">
                <input id="yzfs01" name="yzfsname" type="radio" value="">
                <label for="yzfs01">淘宝帐号</label>
                <input id="yzfs02" name="yzfsname" type="radio" value="">
                <label for="yzfs02">京东帐号</label>
            </div>
            <p id="buserr"></p>
        </div>
        <p class="motwo_annv" onclick="chkbusiness()">确定</p>
    </div>
</div>
<script src="../../js/NEW/jquery-1.10.2.7l.min.js" type="text/javascript"></script>
<script type="text/javascript">
        var token = "";
        var website = "";
        var account = "";
        var pwd_method = 0;
        var name = "";
        var creid = "";
        var mobile = "";
        var uid = "";
        var businessflag = 1;//默认机构有采集电商数据能力
        var yzmflag = 0;//短信验证码标志
        var usermsgflag = 0;

        $(function () {
            $("#loading").css({ "display": "block" });

            //获取用户信息
            $.ajax({
                url: "/juxinli/GetUserInfo.ashx",
                type: "post",
                dataType: "json",
                cache: false,
                data: {
                },
                success: function (msg) {
                    //弹窗
                    var errcode = msg.errcode;
                    var errmsg = msg.errmsg;
                    if (errcode || errmsg) {
                        if (errcode || errmsg) {
                            usermsgflag = 1;
                            $("#loading").css({ "display": "none" });
                            $("#bussele").css({ "display": "none" });
                            $("#remind02 .motwo_wz").html("错误码:" + errcode + "," + errmsg);
                            $("#remind02").css("display", "block");
                            return false;
                        }
                    }
                    else {
                        usermsgflag = 0;
                    }

                    uid = msg.uid;
                    creid = msg.creid;
                    name = msg.name;
                    mobile = msg.mobile;
                }
            });


            //调用聚信立接口，判断机构能力
            $.ajax({
                url: "/juxinli/datasources.ashx",
                type: "post",
                dataType: "json",
                cache: false,
                data: {
                },
                success: function (msg) {
                    $("#loading").css({ "display": "none" });

                    var errcode = msg.errcode;
                    var errmsg = msg.errmsg;
                    if (errcode || errmsg) {
                        if (errcode || errmsg) {
                            usermsgflag = 1;
                            $("#loading").css({ "display": "none" });
                            $("#bussele").css({ "display": "none" });
                            $("#remind02 .motwo_wz").html("错误码:" + errcode + "," + errmsg);
                            $("#remind02").css("display", "block");
                            return false;
                        }
                    }

                    if (usermsgflag == 1)//返回错误信息
                    {
                        return false;
                    }

                    var datasource = $.parseJSON(msg.reponse);
                    if (datasource.success == true) {
                        var data = datasource.data;
                        var namelist = "";
                        for (var i = 0; i < data.length; i++) {
                            namelist += data[i].name + ",";
                        }
                        if (namelist.indexOf("京东") < 0) {
                            $("#label02").css({ "display": "none" });
                        }
                        else if (namelist.indexOf("淘宝") < 0) {
                            $("#label01").css({ "display": "none" });
                        }
                        if (namelist.indexOf("京东") < 0 && namelist.indexOf("淘宝") < 0) {
                            businessflag = 0;//无采集电商数据能力                          
                        }
                        if (businessflag != 0) {
                            $("#bussele").css({ "display": "block" });
                        }
                        else {
                            application();//直接提交申请
                        }
                    }
                    else { //请求失败
                        $("#remind02 .motwo_wz").html("系统繁忙，请稍后重试");
                        $("#remind02").css("display", "block");
                        return false;
                    }
                }
            });
        

            $(".onli_yzfs input[type=radio]").bind("click", function () {
                if ($(this).attr("checked")) {
                    $(this).attr("checked", false);
                    $(this).next("label").removeClass("pass");
                }
                else {
                    $(this).attr("checked", true);
                    $(this).next("label").addClass("pass");
                }
                $("#buserr").css({"display": "none"});
            });


            //$(".upflpic i").each(function (i) {
            //    $(this).click(function () {
            //        $(this).parent().remove();
            //    })
            //});
               

            //$("input").focusin(function () {
            //    if ($(this).val().indexOf("请输入") > -1) {
            //        $(this).attr("style", "color:black");
            //        $(this).val("");
            //    }
            //});

           
        });
        
        //电商确认
        function chkbusiness()
        {
            if(!$("#yzfs01").attr("checked") && !$("#yzfs02").attr("checked"))
            {
                //提示选择电商
                $("#bussele").css({ "display": "block" });
                $("#buserr").html("请选择验证的电商数据");
                $("#buserr").css({"display": "block","color": "red"});
                return false;
            }
            application();
        }

        //提交申请单
        function application()
        {
            var seleweb = "";
            if ($("#yzfs01").attr("checked") && !$("#yzfs02").attr("checked")) {
                seleweb = "[{'name':'taobao','category':'e_business'}]";
            }
            else if ($("#yzfs02").attr("checked") && !$("#yzfs01").attr("checked")) {
                seleweb = "[{'name':'jingdong','category':'e_business'}]";
            }
            else if ($("#yzfs02").attr("checked") && $("#yzfs01").attr("checked")) {
                seleweb = "[{'name':'taobao','category':'e_business'},{'name':'jingdong','category':'e_business'}]";
            }
            else
            {
                seleweb = "[]";
            }

            var chkData = "{'basic_info':{'name':'" + name + "','id_card_num':'" + creid + "','cell_phone_num':'" + mobile + "'},'skip_mobile':false,'uid':'" + uid + "','selected_website':" + seleweb + "}";

            $("#bussele").css({"display": "none"});
            $("#loading").css({ "display": "block" });

            $.ajax({
                url: "/juxinli/applications.ashx",
                type: "post",
                dataType: "json",
                cache: false,
                data: {
                    "request": chkData
                },
                success: function (msg) {
                    var errcode = msg.errcode;
                    var errmsg = msg.errmsg;
                    if (errcode || errmsg) {
                        if (errcode || errmsg) {
                            usermsgflag = 1;
                            $("#loading").css({ "display": "none" });
                            $("#bussele").css({ "display": "none" });
                            $("#remind02 .motwo_wz").html("错误码:" + errcode + "," + errmsg);
                            $("#remind02").css("display", "block");
                            return false;
                        }
                    }

                    var datasource = $.parseJSON(msg.reponse);
                    $("#loading").css({ "display": "none" });
                    //var datasource = $.parseJSON(msg);
                    if (datasource.success == true) {
                        var data = datasource.data;
                        token = data.token;
                        website = data.datasource.website;
                        account = data.cell_phone_num;
                        pwd_method = data.datasource.reset_pwd_method;
                        if (pwd_method != 0) {
                            $("#retrunlog").css({"display": "none"});
                            $("div .bank_bom").css({ "display": "block" });
                        }
                        var status = data.datasource.status;
                        if (status != 1)//运营商不支持或已下线
                        {
                            if (seleweb == "[]")//没有选择电商，结束采集数据
                            {
                                window.location.href = "/Tenant/Personal/Personal.aspx";//跳转个人中心
                            }
                            else //跳转采集电商数据
                            {
                                window.location.href = "ValidateShop-juxinli.html?token=" + token + "&website=" + website;
                            }
                        }
                    }
                    else { //请求失败
                        $("#remind02 .motwo_wz").html("系统繁忙，请稍后重试");
                        $("#remind02").css("display", "block");
                        return false;
                    }
                }
            });
        }


        function msg_req(type_in) {
            if (usermsgflag == 1)//返回错误信息
            {
                $("#remind02 .motwo_wz").html("系统繁忙，请稍后重试");
                $("#remind02").css("display", "block");
                return false;
            }

            $("#remind01").css({"display": "none"});
            var type = "";
            var captcha = $("#reqyzm").val().trim();
            var reg01 = /^\d{6}$/;
            var reg02 = /^\d{8}$/;
            if (type_in != "" && type_in != null)
            {
                type = type_in;
            }
            else if ($("#phone").val().trim() == "" || (!reg01.test($("#phone").val().trim()) && !reg02.test($("#phone").val().trim())))
            {
                $("#remind02 .motwo_wz").html("请输入服务密码");
                $("#remind02").css("display", "block");
                return false;
            }

            if (type_in == "SUBMIT_CAPTCHA")//提交短信验证码
            {
                if (captcha == "" || !reg01.test(captcha))
                {
                    $("#remind01").css({ "display": "block" });
                    return false;
                }             
            }
            $("#loading").css({ "display": "block" });
            var msgReqData = "{'token':'" + token + "','account':'" + account + "','password':'" + $("#phone").val() + "','captcha':'" + captcha + "','type':'" + type + "','website':'" + website + "'}";
            $.ajax({
                url: "/juxinli/messages_req.ashx",
                type: "post",
                dataType: "json",
                cache: false,
                data: {
                    "request": msgReqData
                },
                success: function (msg) {
                    $("#loading").css({ "display": "none" });
                    var errcode = msg.errcode;
                    var errmsg = msg.errmsg;
                    if (errcode || errmsg) {
                        if (errcode || errmsg) {
                            usermsgflag = 1;
                            $("#loading").css({ "display": "none" });
                            $("#bussele").css({ "display": "none" });
                            $("#remind02 .motwo_wz").html("错误码:" + errcode + "," + errmsg);
                            $("#remind02").css("display", "block");
                            return false;
                        }
                    }

                    var datasource = $.parseJSON(msg.reponse);
                    if (datasource.success == true) {
                        var data = datasource.data;
                        if (data.process_code == 10003)//密码错误
                        {
                            $("#remind02 .motwo_wz").html("密码错误，请重新输入");
                            $("#remind02").css("display", "block");
                            $("#phone").val("");
                        }
                        else if (data.process_code == 10004 || data.process_code == 10006)//短信验证码错误/失效
                        {
                            $("#remind01 #yzmerr").css({"display": "block"});
                            $("#remind01 #yzmerr").html("短信验证码错误/失效，请重新输入");
                            $("#remind01").css({ "display": "block" });
                        }
                        else if (data.process_code == 10007)//简单密码或初始密码无法登录
                        {
                            $("#remind02 .motwo_wz").html("验证失败，请修改密码后重试");
                            $("#remind02").css("display", "block");
                        }
                        else if (data.process_code == 30000 || data.process_code == 0)//采集请求超时
                        {
                            $("#remind02 .motwo_wz").html("验证失败，请稍后再试");
                            $("#remind02").css("display", "block");
                        }
                        else if (data.process_code == 10002 || data.process_code == 10001)//输入短信验证码
                        {
                            $("#remind01").css({"display": "block"});
                        }
                        else if (data.process_code == 10008)//开始采集数据
                        {
                            //跳转电商采集数据
                            if (data.finish != true) {
                                var next_datasource = data.next_datasource;
                                window.location.href = "ValidateShop-juxinli.html?token=" + token + "&website=" + next_datasource.website;
                            }
                            else {
                                //设置采集完成标志
                                window.location.href = "/Tenant/Personal/Personal.aspx";//跳转个人中心
                            }                  
                        }
                        
                    }
                    else { //请求失败
                        $("#remind02 .motwo_wz").html("系统繁忙，请稍后重试");
                        $("#remind02").css("display", "block");
                        return false;
                    }
                }
            });
        };


        function reset_pw(type_in)
        {
            var type = "";
            if (type_in != "" && type_in != null)
            {
                type = type_in;
            }
            if (pwd_method == 1)
            {
                $("#newyzm").css({"display": "block"});    
            }
            else if(pwd_method == 2)
            {
                $("#newpw").css({ "display": "block" });
                $("#newyzm").css({"display": "block" });
            }
            $("#fwpw").css({"display": "none"});

            if ($("#resetpw").val() == "忘记密码")
            {
                $("#resetpw").val("重置密码");
                $("#retrunlog").css({ "display": "inline-block" });
            }         
            $("#loading").css({ "display": "block" });
            var forgetData = "{'token':'" + token + "','account':'" + account + "','password':'" + $("#newfwpw").val().trim() + "','captcha':'" + $("#newfwyzm").val().trim() + "','type':'" + type + "','website':'" + website + "'}";
            $.ajax({
                url: "/juxinli/messages_reset.ashx",
                type: "post",
                dataType: "json",
                cache: false,
                data: {
                    "request": forgetData
                },
                success: function (msg) {
                    $("#loading").css({ "display": "none" });
                    var errcode = msg.errcode;
                    var errmsg = msg.errmsg;
                    if (errcode || errmsg) {
                        if (errcode || errmsg) {
                            usermsgflag = 1;
                            $("#loading").css({ "display": "none" });
                            $("#bussele").css({ "display": "none" });
                            $("#remind02 .motwo_wz").html("错误码:" + errcode + "," + errmsg);
                            $("#remind02").css("display", "block");
                            return false;
                        }
                    }

                    var datasource = $.parseJSON(msg.reponse);
                    if (datasource.success == true) {
                        var data = datasource.data;
                        if (data.process_code == 31000 || data.process_code == 30000)//重置密码失败，建议到营业厅重置密码
                        {
                            $("#remind02 .motwo_wz").html("建议按下图方式找回服务密码");
                            $("#remind02").css("display", "block");
                        }
                        else if (data.process_code == 10004)//短信验证码错误
                        {
                            $("#remind02 .motwo_wz").html("短信验证码错误，请重新输入");
                            $("#remind02").css("display", "block");
                        }
                        //else if (data.process_code == 10002 || data.process_code == 10001)//输入短信验证码
                        //{
                           
                        //}
                        else if (data.process_code == 0)//请求超时
                        {
                            $("#remind02 .motwo_wz").html("重置密码失败，请稍后再试");
                            $("#remind02").css("display", "block");
                        }
                        else if (data.process_code == 11000)//重置密码成功
                        {
                            $("#remind02 .motwo_wz").html("重置成功，请重新登录");
                            $("#remind02").css("display", "block");
                        }
                    }
                    else { //请求失败
                        $("#remind02 .motwo_wz").html("系统繁忙，请稍后重试");
                        $("#remind02").css("display", "block");
                        return false;
                    }
                }
            });
        }

        function relogin()
        {
            //隐藏服务密码输入
            $("#retrunlog").css({ "display": "none" });
            $("#resetpw").val("忘记密码");
            $("#newpw").css({ "display": "none" });
            $("#newyzm").css({ "display": "none" });
            $("#phone").val("");
            $("#fwpw").css({ "display": "block" });
        }

        //重发短信验证码：重置密码
        function reset_sendyzm()
        {
            $("#newfwpw").val("");
            $("#newfwyzm").val("");
            reset_pw("RESEND_RESET_PWD_CAPTCHA");
        }

        //重发短信验证码
        function resendyzm()
        {
            msg_req("RESEND_CAPTCHA");
        }

        //提交短信验证码
        function submityzm()
        {
            msg_req("SUBMIT_CAPTCHA");
        }

        //function chkpw()
        //{

        //}

        function inputyzm()
        {
            var reg01 = /^\d{6}$/;
            var yzm = $("#fwword").val().trim();
            if (yzm == "" || !reg01.test(yzm))
            {
                $("#remind01").css({ "display": "block" });
                $("#remind01 #yzmerr").css({ "display": "block" });
                return false;
            }

            submityzm();

        }

        function reqyzmfocus() {
            $("#yzmerr").css({ "display": "none" });
            //$("#reqyzm").val("");
        };

        function IsNumber(obj) {
            Reg = /^\d+$/;
            if (Reg.test(obj)) {
                return true;
            } else {
                return false;
            }
        }
        
    </script>
</body>
</html>
